<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Python REPL</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root { --bg: #1e1e1e; --sidebar: #252526; --accent: #007acc; --text: #cccccc; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: var(--bg); color: var(--text); overflow: hidden; }
        
        #sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #333; }
        #session-list { flex: 1; overflow-y: auto; padding: 10px; }
        .session-item { 
            padding: 10px; margin-bottom: 8px; background: #333; border-radius: 4px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        .session-item.active { border-left: 4px solid var(--accent); background: #444; }
        
        #main { flex: 1; display: flex; flex-direction: column; }
        #status-bar { padding: 6px 20px; font-size: 11px; background: #111; color: #888; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        #terminal { flex: 1; overflow-y: auto; padding: 20px; font-family: 'Consolas', monospace; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
        
        .input-line { color: #569cd6; margin-top: 12px; font-weight: bold; }
        .output-line { color: #ce9178; margin-top: 4px; }
        .error-line { color: #f44747; margin-top: 4px; border-left: 2px solid #f44747; padding-left: 8px; font-size: 13px; }

        #input-container { background: #111; padding: 15px; border-top: 1px solid #333; }
        #cmd { 
            background: transparent; border: none; color: #fff; width: 100%; 
            font-family: 'Consolas', monospace; outline: none; font-size: 14px; 
            resize: none; line-height: 1.5;
        }
        .hint { font-size: 11px; color: #555; margin-top: 8px; }
        button.primary { background: var(--accent); color: white; border: none; padding: 10px; cursor: pointer; width: 100%; border-radius: 4px; font-weight: bold; }
        .btn-del { color: #888; border: none; background: transparent; cursor: pointer; font-size: 16px; }
        .btn-del:hover { color: #ff5f56; }

        .session-info { display: flex; align-items: center; gap: 8px; overflow: hidden; }
        .session-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .edit-icon { font-size: 12px; opacity: 0.5; cursor: pointer; padding: 2px; }
        .edit-icon:hover { opacity: 1; color: var(--accent); }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header"><button class="primary" onclick="createNewSession()">+ New Session</button></div>
    <div id="session-list"></div>
</div>

<div id="main">
    <div id="status-bar">
        <span id="kernel-status">Initializing Pyodide...</span>
        <span id="session-label"></span>
    </div>
    <div id="terminal"></div>
    <div id="input-container">
        <textarea id="cmd" rows="1" placeholder="Please wait..." disabled spellcheck="false"></textarea>
        <div class="hint"><strong>Tab</strong> to indent. <strong>Enter</strong> on blank line to run. <strong>Ctrl+Enter</strong> to run immediately.</div>
    </div>
</div>

<script>
    let pyodide;
    let sessions = JSON.parse(localStorage.getItem('py_v6_sessions') || '{}');
    let currentId = localStorage.getItem('py_v6_active_id');
    let isBusy = false;

    async function init() {
        pyodide = await loadPyodide();
        await pyodide.runPythonAsync("namespaces = {}");
        
        setStatus("Ready");
        const cmd = document.getElementById('cmd');
        cmd.disabled = false;
        cmd.placeholder = "Write Python...";

        if (!currentId || !sessions[currentId]) {
            createNewSession();
        } else {
            renderSessionList();
            renderTerminal();
            rehydrateAllSessions();
        }
    }

    async function setStatus(msg) {
        document.getElementById('kernel-status').innerText = msg;
    }

    async function rehydrateAllSessions() {
        isBusy = true;
        setStatus("Restoring context...");
        for (const id in sessions) {
            await pyodide.runPythonAsync(`namespaces["${id}"] = {}`);
            const inputs = sessions[id].history.filter(h => h.type === 'input');
            for (const item of inputs) {
                try {
                    await pyodide.runPythonAsync(`exec(${JSON.stringify(item.content)}, namespaces["${id}"])`);
                } catch (e) { console.warn("Rehydration skip:", e); }
            }
        }
        isBusy = false;
        setStatus("Ready");
    }

    async function runCode() {
        if (isBusy) return;
        const cmdInput = document.getElementById('cmd');
        const code = cmdInput.value.trimEnd();
        if (!code) return;

        setStatus("Running...");
        await pyodide.runPythonAsync(`if "${currentId}" not in namespaces: namespaces["${currentId}"] = {}`);

        sessions[currentId].history.push({ type: 'input', content: code });
        renderTerminal();
        cmdInput.value = '';
        cmdInput.rows = 1;
        cmdInput.style.height = 'auto';

        try {
            const pyWrapper = `
import sys, io
sys.stdout = io.StringIO()
ns = namespaces["${currentId}"]
source = ${JSON.stringify(code)}
try:
    res = eval(source, ns)
except SyntaxError:
    res = exec(source, ns)
out = sys.stdout.getvalue()
if res is not None: out += str(res)
out.strip()
            `;
            let result = await pyodide.runPythonAsync(pyWrapper);
            if (result) sessions[currentId].history.push({ type: 'output', content: result });
        } catch (err) {
            sessions[currentId].history.push({ type: 'error', content: err.message });
        }

        save();
        renderTerminal();
        setStatus("Ready");
    }

    function renderTerminal() {
        const term = document.getElementById('terminal');
        const session = sessions[currentId];
        document.getElementById('session-label').innerText = session.name;
        term.innerHTML = session.history.map(item => {
            const prefix = item.type === 'input' ? '>>> ' : '';
            return `<div class="${item.type}-line">${prefix}${item.content}</div>`;
        }).join('');
        term.scrollTop = term.scrollHeight;
    }

    function createNewSession() {
        const id = 's' + Date.now();
        sessions[id] = { id, name: "New Session", history: [] };
        currentId = id;
        if(pyodide) pyodide.runPython(`namespaces["${id}"] = {}`);
        save();
        renderSessionList();
        renderTerminal();
    }

    function save() {
        localStorage.setItem('py_v6_sessions', JSON.stringify(sessions));
        localStorage.setItem('py_v6_active_id', currentId);
    }

    function renderSessionList() {
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        
        // Object.values returns sessions, .reverse() puts newest at top
        Object.values(sessions).reverse().forEach(s => {
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentId ? 'active' : ''}`;
            
            // Clicking the item switches the session
            div.onclick = () => { 
                currentId = s.id; 
                save(); 
                renderSessionList(); 
                renderTerminal(); 
            };

            // Right-click still works as a shortcut
            div.oncontextmenu = (e) => { 
                e.preventDefault(); 
                renameSession(s.id); 
            };

            div.innerHTML = `
                <div class="session-info">
                    <span class="session-name">${s.name}</span>
                    <span class="edit-icon" onclick="event.stopPropagation(); renameSession('${s.id}')">✎</span>
                </div>
                <button class="btn-del" onclick="deleteSession(event, '${s.id}')">×</button>
            `;
            list.appendChild(div);
        });
    }

    function renameSession(id) {
        const n = prompt("Rename Session:", sessions[id].name);
        if(n) { sessions[id].name = n; save(); renderSessionList(); renderTerminal(); }
    }

    function deleteSession(e, id) {
        e.stopPropagation();
        if(!confirm("Delete session?")) return;
        delete sessions[id];
        if(pyodide) pyodide.runPython(`namespaces.pop("${id}", None)`);
        const keys = Object.keys(sessions);
        if (keys.length === 0) createNewSession();
        else { if (currentId === id) currentId = keys[0]; save(); renderSessionList(); renderTerminal(); }
    }

    const cmd = document.getElementById('cmd');
    
    cmd.addEventListener('keydown', function(e) {
        const start = this.selectionStart;
        const end = this.selectionEnd;

        // 1. Handle Tab
        if (e.key === 'Tab') {
            e.preventDefault();
            // Insert 4 spaces
            this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }

        // 2. Handle Enter
        if (e.key === 'Enter' && !e.shiftKey) {
            const lines = this.value.split('\n');
            const currentLine = lines[lines.length - 1];

            // If Ctrl+Enter OR Enter on a blank line at end of block
            if (e.ctrlKey || (this.value.trim() !== "" && currentLine.trim() === "")) {
                e.preventDefault();
                runCode();
                return;
            }

            // Auto-indent after a colon
            if (currentLine.trim().endsWith(':')) {
                // We let the default enter happen, but we'll add spaces in the next tick
                setTimeout(() => {
                    const pos = this.selectionStart;
                    this.value = this.value.substring(0, pos) + "    " + this.value.substring(pos);
                    this.selectionStart = this.selectionEnd = pos + 4;
                }, 0);
            }
        }

        // Auto-resize
        setTimeout(() => {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        }, 0);
    });

    init();
</script>
</body>
</html>